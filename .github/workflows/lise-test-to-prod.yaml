name: deploy-test-to-prod-ALL

on:
  push:
    branches:
      - main          # runs when dev is merged into main
  workflow_dispatch:  # also allow manual run

jobs:
  deploy:
    runs-on: windows-latest
    environment: prod   # uses 'prod' environment for secrets/approvals

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Deploy-Fabric.ps1 (Test → Prod, include DF_GOLD + PL_GOLD + PL_Payroll)
        shell: pwsh
        run: |
          # IMPORTANT:
          # Override default ExcludeItemTypes so we DO NOT exclude Dataflow or DataPipeline.
          $excludeTypes = @(
            "Warehouse",        # still avoid warehouse if needed
            "VariableLibrary",
            "SQLEndpoint",
            "Dashboard"
            # NOTE: no Dataflow / DataflowGen2 / DataPipeline here
          )

          $params = @{
            TenantId         = "${{ secrets.FABRIC_TENANT_ID }}"
            ClientId         = "${{ secrets.FABRIC_CLIENT_ID }}"
            ClientSecret     = "${{ secrets.FABRIC_CLIENT_SECRET }}"
            PipelineName     = "DP_LISE"
            SourceStage      = "Test"
            TargetStage      = "Production"
            Note             = "Test → Prod deploy (include DF_GOLD + PL_GOLD + PL_Payroll) – run $env:GITHUB_RUN_ID"
            ExcludeItemTypes = $excludeTypes
            # ItemsJson not set → script uses ALL deployable items from Test → Prod
          }

          ./ops/Deploy-Fabric.ps1 @params
