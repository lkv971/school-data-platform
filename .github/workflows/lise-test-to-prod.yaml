name: deploy-test-to-prod

on:
  push:
    branches:
      - main          # runs when you merge dev -> main
  workflow_dispatch:  # also allow manual run

jobs:
  deploy:
    runs-on: windows-latest
    environment: prod   # uses 'prod' env for secrets/approvals

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Deploy-Fabric.ps1 (Test → Prod SAFE: lakehouses + notebooks only)
        shell: pwsh
        run: |
          # Exclude everything except Lakehouse + Notebook
          $excludeTypes = @(
            "SemanticModel",
            "Report",
            "VariableLibrary",
            "SQLEndpoint",
            "Dashboard",
            "Warehouse",
            "Dataflow",
            "DataflowGen2",
            "DataPipeline"   # excludes PL_BRONZE, PL_SILVER, PL_GOLD, PL_Payroll
          )

          $params = @{
            TenantId         = "${{ secrets.FABRIC_TENANT_ID }}"
            ClientId         = "${{ secrets.FABRIC_CLIENT_ID }}"
            ClientSecret     = "${{ secrets.FABRIC_CLIENT_SECRET }}"
            PipelineName     = "DP_LISE"
            SourceStage      = "Test"
            TargetStage      = "Production"
            Note             = "Test → Prod SAFE deploy (lakehouses + notebooks only) – run $env:GITHUB_RUN_ID"
            ExcludeItemTypes = $excludeTypes
          }

          ./ops/Deploy-Fabric.ps1 @params
